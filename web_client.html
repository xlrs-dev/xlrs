<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPV RC Web Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .connection-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .connection-panel input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .connection-panel button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .connection-panel button:hover {
            background: #45a049;
        }
        
        .connection-panel button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.discovering {
            background: #fff3cd;
            color: #856404;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stick-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .stick-container h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .joystick-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            background: #f0f0f0;
            border-radius: 50%;
            border: 3px solid #ddd;
            cursor: pointer;
            touch-action: none;
        }
        
        .joystick-handle {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: background 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .joystick-handle.active {
            background: #45a049;
        }
        
        .channel-values {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        
        .channel-value {
            text-align: center;
        }
        
        .channel-value label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .channel-value span {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .aux-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .aux-container h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .aux-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .aux-button {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .aux-button:hover {
            border-color: #4CAF50;
        }
        
        .aux-button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .info-panel {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .info-panel h4 {
            margin-bottom: 10px;
            color: #1976d2;
        }
        
        .info-panel p {
            font-size: 12px;
            color: #555;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FPV RC Web Client</h1>
        <p class="subtitle">Control your FPV drone from your browser</p>
        
        <div class="connection-panel">
            <input type="text" id="rxIP" placeholder="RX IP Address (e.g., 192.168.1.100)" value="">
            <button id="discoverBtn" onclick="discoverRX()">Discover RX</button>
            <button id="connectBtn" onclick="connectToRX()">Connect</button>
            <button id="disconnectBtn" onclick="disconnectFromRX()" disabled>Disconnect</button>
        </div>
        
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div class="controls-grid">
            <div class="stick-container">
                <h3>Stick 1 - Aileron & Elevator</h3>
                <div class="joystick-wrapper" id="stick1">
                    <div class="joystick-handle" id="handle1"></div>
                </div>
                <div class="channel-values">
                    <div class="channel-value">
                        <label>Aileron</label>
                        <span id="ch0">1500</span>
                    </div>
                    <div class="channel-value">
                        <label>Elevator</label>
                        <span id="ch1">1500</span>
                    </div>
                </div>
            </div>
            
            <div class="stick-container">
                <h3>Stick 2 - Throttle & Rudder</h3>
                <div class="joystick-wrapper" id="stick2">
                    <div class="joystick-handle" id="handle2"></div>
                </div>
                <div class="channel-values">
                    <div class="channel-value">
                        <label>Throttle</label>
                        <span id="ch2">1500</span>
                    </div>
                    <div class="channel-value">
                        <label>Rudder</label>
                        <span id="ch3">1500</span>
                    </div>
                </div>
            </div>
            
            <div class="aux-container">
                <h3>Auxiliary Channels</h3>
                <div class="aux-buttons">
                    <button class="aux-button" id="aux1" onclick="toggleAux(4)">Aux 1: OFF</button>
                    <button class="aux-button" id="aux2" onclick="toggleAux(5)">Aux 2: OFF</button>
                    <button class="aux-button" id="aux3" onclick="toggleAux(6)">Aux 3: OFF</button>
                    <button class="aux-button" id="aux4" onclick="toggleAux(7)">Aux 4: OFF</button>
                </div>
            </div>
        </div>
        
        <div class="info-panel">
            <h4>Instructions</h4>
            <p>
                <strong>Connection:</strong> Enter the RX IP address or click "Discover RX" to find it automatically (requires RX to be on the same network).<br>
                <strong>Controls:</strong> Click and drag the joysticks to control Aileron/Elevator and Throttle/Rudder. Use the buttons for auxiliary channels.<br>
                <strong>Channel Range:</strong> 1000-2000 microseconds (1500 = center).<br>
                <strong>Note:</strong> This web client uses HTTP endpoints. For lower latency, use the native TX firmware.
            </p>
        </div>
    </div>

    <script>
        // Channel values (8 channels: AETR + 4 aux)
        let channels = [1500, 1500, 1500, 1500, 1000, 1000, 1000, 1000];
        let auxStates = [false, false, false, false];
        let connected = false;
        let sendInterval = null;
        let rxIP = '';
        let sequenceNumber = 0;
        
        // Initialize joysticks
        function initJoystick(stickId, handleId, chX, chY) {
            const wrapper = document.getElementById(stickId);
            const handle = document.getElementById(handleId);
            const rect = wrapper.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const radius = rect.width / 2 - 20;
            
            let active = false;
            
            function moveJoystick(e) {
                if (!active) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                let dx = clientX - centerX;
                let dy = clientY - centerY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > radius) {
                    dx = dx * radius / dist;
                    dy = dy * radius / dist;
                }
                
                handle.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                
                const xVal = Math.round(1500 + (dx / radius) * 500);
                const yVal = Math.round(1500 - (dy / radius) * 500);
                
                channels[chX] = Math.max(1000, Math.min(2000, xVal));
                channels[chY] = Math.max(1000, Math.min(2000, yVal));
                
                updateDisplay(chX);
                updateDisplay(chY);
                e.preventDefault();
            }
            
            function stopJoystick() {
                active = false;
                handle.classList.remove('active');
                handle.style.transform = 'translate(-50%, -50%)';
                channels[chX] = 1500;
                channels[chY] = 1500;
                updateDisplay(chX);
                updateDisplay(chY);
            }
            
            wrapper.addEventListener('mousedown', (e) => {
                active = true;
                handle.classList.add('active');
                moveJoystick(e);
            });
            
            wrapper.addEventListener('touchstart', (e) => {
                active = true;
                handle.classList.add('active');
                moveJoystick(e);
            });
            
            document.addEventListener('mousemove', moveJoystick);
            document.addEventListener('touchmove', moveJoystick);
            document.addEventListener('mouseup', stopJoystick);
            document.addEventListener('touchend', stopJoystick);
        }
        
        // Initialize both joysticks
        initJoystick('stick1', 'handle1', 0, 1); // Aileron, Elevator
        initJoystick('stick2', 'handle2', 2, 3); // Throttle, Rudder
        
        function toggleAux(ch) {
            auxStates[ch - 4] = !auxStates[ch - 4];
            channels[ch] = auxStates[ch - 4] ? 2000 : 1000;
            
            const btn = document.getElementById(`aux${ch - 3}`);
            btn.textContent = `Aux ${ch - 3}: ${auxStates[ch - 4] ? 'ON' : 'OFF'}`;
            btn.classList.toggle('active', auxStates[ch - 4]);
        }
        
        function updateDisplay(ch) {
            const element = document.getElementById(`ch${ch}`);
            if (element) {
                element.textContent = channels[ch];
            }
        }
        
        async function discoverRX() {
            const status = document.getElementById('status');
            status.className = 'status discovering';
            status.textContent = 'Discovering RX...';
            
            // Try to discover RX via HTTP endpoint
            // Note: Browsers can't do UDP, so we'll try common IP ranges or use manual entry
            const commonIPs = [];
            const localIP = window.location.hostname;
            const parts = localIP.split('.');
            
            if (parts.length === 4) {
                // Generate common IPs in same subnet
                for (let i = 1; i <= 254; i++) {
                    commonIPs.push(`${parts[0]}.${parts[1]}.${parts[2]}.${i}`);
                }
            } else {
                // Fallback: try common ranges
                for (let i = 1; i <= 254; i++) {
                    commonIPs.push(`192.168.1.${i}`);
                    commonIPs.push(`192.168.0.${i}`);
                }
            }
            
            // Try to find RX by checking HTTP endpoint
            for (const ip of commonIPs.slice(0, 50)) { // Limit to first 50 for speed
                try {
                    const response = await fetch(`http://${ip}/`, { method: 'HEAD', timeout: 100 });
                    if (response.ok) {
                        rxIP = ip;
                        document.getElementById('rxIP').value = ip;
                        status.className = 'status connected';
                        status.textContent = `RX discovered at ${ip}`;
                        return;
                    }
                } catch (e) {
                    // Continue searching
                }
            }
            
            status.className = 'status disconnected';
            status.textContent = 'RX not found. Please enter IP manually.';
        }
        
        function connectToRX() {
            rxIP = document.getElementById('rxIP').value.trim();
            if (!rxIP) {
                alert('Please enter RX IP address');
                return;
            }
            
            connected = true;
            document.getElementById('status').className = 'status connected';
            document.getElementById('status').textContent = `Connected to ${rxIP}`;
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            document.getElementById('discoverBtn').disabled = true;
            
            // Start sending channel data at 50Hz (20ms intervals)
            if (sendInterval) clearInterval(sendInterval);
            sendInterval = setInterval(sendChannelData, 20);
        }
        
        function disconnectFromRX() {
            connected = false;
            if (sendInterval) {
                clearInterval(sendInterval);
                sendInterval = null;
            }
            
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('discoverBtn').disabled = false;
            
            // Reset channels to center
            channels = [1500, 1500, 1500, 1500, 1000, 1000, 1000, 1000];
            auxStates = [false, false, false, false];
            // Only update displays for channels 0-3 (the ones that have display elements)
            for (let i = 0; i < 4; i++) {
                updateDisplay(i);
            }
            document.querySelectorAll('.aux-button').forEach((btn, i) => {
                btn.textContent = `Aux ${i + 1}: OFF`;
                btn.classList.remove('active');
            });
        }
        
        let errorCount = 0;
        
        async function sendChannelData() {
            if (!connected) return;
            
            try {
                // Send via HTTP POST (using JSON for compatibility with existing endpoint)
                // Note: For binary protocol with security, we'd need WebSocket support on RX
                const response = await fetch(`http://${rxIP}/channels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ch: channels })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                // Reset error count on success
                errorCount = 0;
            } catch (error) {
                console.error('Error sending channel data:', error);
                // Don't disconnect immediately on single error - might be temporary
                // Only disconnect if we get multiple consecutive errors
                errorCount++;
                if (errorCount > 5) {
                    disconnectFromRX();
                    errorCount = 0;
                }
            }
        }
        
        // Allow Enter key to connect
        document.getElementById('rxIP').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectToRX();
            }
        });
    </script>
</body>
</html>

